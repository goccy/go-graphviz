CC := clang

GRAPHVIZ_ROOT := /graphviz
EXPAT_ROOT := /expat

TARGET := graphviz.wasm

build:
	ccache $(CC) \
		-g0 -Os \
		--sysroot=/opt/wasi-sdk/share/wasi-sysroot \
		--target=wasm32-wasi \
		-Wextra \
		-Wno-format-security \
		-Wno-bitwise-instead-of-logical \
		-Wno-implicit-function-declaration \
		-Wno-incompatible-pointer-types-discards-qualifiers \
		-Wno-sign-compare \
		-Wno-missing-field-initializers \
		-Wno-undef \
		-Wno-uninitialized \
		-Wno-unused \
		-Wno-unused-parameter \
		-Wno-write-strings \
		-Wno-char-subscripts \
		-Wno-writable-strings \
		-Wl,--export-all \
		-Wl,--no-entry \
		-Wl,--error-limit=0 \
		-Wl,--import-undefined \
		-funsigned-char \
		-D_WASI_EMULATED_SIGNAL \
		-D_WASI_EMULATED_MMAN \
		-D_WASI_EMULATED_PROCESS_CLOCKS \
		-lwasi-emulated-mman \
		-lwasi-emulated-getpid \
		-lwasi-emulated-signal \
		-lwasi-emulated-process-clocks \
		-I$(GRAPHVIZ_ROOT) \
		-I$(GRAPHVIZ_ROOT)/lib/ \
		-I$(GRAPHVIZ_ROOT)/lib/ast \
		-I$(GRAPHVIZ_ROOT)/lib/cdt \
		-I$(GRAPHVIZ_ROOT)/lib/cgraph \
		-I$(GRAPHVIZ_ROOT)/lib/circogen \
		-I$(GRAPHVIZ_ROOT)/lib/common \
		-I$(GRAPHVIZ_ROOT)/lib/dotgen \
		-I$(GRAPHVIZ_ROOT)/lib/edgepaint \
		-I$(GRAPHVIZ_ROOT)/lib/expr \
		-I$(GRAPHVIZ_ROOT)/lib/fdpgen \
		-I$(GRAPHVIZ_ROOT)/lib/gvc \
		-I$(GRAPHVIZ_ROOT)/lib/label \
		-I$(GRAPHVIZ_ROOT)/lib/mingle \
		-I$(GRAPHVIZ_ROOT)/lib/neatogen \
		-I$(GRAPHVIZ_ROOT)/lib/ortho \
		-I$(GRAPHVIZ_ROOT)/lib/osage \
		-I$(GRAPHVIZ_ROOT)/lib/pack \
		-I$(GRAPHVIZ_ROOT)/lib/patchwork \
		-I$(GRAPHVIZ_ROOT)/lib/pathplan \
		-I$(GRAPHVIZ_ROOT)/lib/rbtree \
		-I$(GRAPHVIZ_ROOT)/lib/sfdpgen \
		-I$(GRAPHVIZ_ROOT)/lib/sfio \
		-I$(GRAPHVIZ_ROOT)/lib/sparse \
		-I$(GRAPHVIZ_ROOT)/lib/topfish \
		-I$(GRAPHVIZ_ROOT)/libtwopigen \
		-I$(GRAPHVIZ_ROOT)/lib/util \
		-I$(GRAPHVIZ_ROOT)/lib/vmalloc \
		-I$(GRAPHVIZ_ROOT)/lib/vpsc \
		-I$(GRAPHVIZ_ROOT)/lib/xdot \
		-I$(EXPAT_ROOT) \
		-I$(EXPAT_ROOT)/lib \
		$(GRAPHVIZ_ROOT)/lib/ast/*.c \
		$(GRAPHVIZ_ROOT)/lib/cdt/*.c \
		$(GRAPHVIZ_ROOT)/lib/cgraph/*.c \
		$(GRAPHVIZ_ROOT)/lib/circogen/*.c \
		$(GRAPHVIZ_ROOT)/lib/common/*.c \
		$(GRAPHVIZ_ROOT)/lib/dotgen/*.c \
		$(GRAPHVIZ_ROOT)/lib/edgepaint/*.c \
		$(GRAPHVIZ_ROOT)/lib/expr/*.c \
		$(GRAPHVIZ_ROOT)/lib/fdpgen/*.c \
		$(GRAPHVIZ_ROOT)/lib/gvc/*.c \
		$(GRAPHVIZ_ROOT)/lib/label/*.c \
		$(GRAPHVIZ_ROOT)/lib/ortho/*.c \
		$(GRAPHVIZ_ROOT)/lib/osage/*.c \
		$(GRAPHVIZ_ROOT)/lib/pack/*.c \
		$(GRAPHVIZ_ROOT)/lib/patchwork/*.c \
		$(GRAPHVIZ_ROOT)/lib/pathplan/*.c \
		$(GRAPHVIZ_ROOT)/lib/rbtree/*.c \
		$(GRAPHVIZ_ROOT)/lib/sfdpgen/*.c \
		$(GRAPHVIZ_ROOT)/lib/sfio/*.c \
		$(GRAPHVIZ_ROOT)/lib/sfio/Sfio_f/_sfslen.c \
		$(GRAPHVIZ_ROOT)/lib/sparse/*.c \
		$(GRAPHVIZ_ROOT)/lib/util/*.c \
		$(GRAPHVIZ_ROOT)/lib/vmalloc/*.c \
		$(GRAPHVIZ_ROOT)/lib/xdot/*.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/adjust.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/circuit.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/edges.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/geometry.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/heap.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/hedges.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/info.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/neatoinit.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/legal.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/lu.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/matinv.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/memory.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/poly.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/site.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/solve.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/neatosplines.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/stuff.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/voronoi.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/stress.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/kkutils.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/matrix_ops.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/embed_graph.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/dijkstra.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/conjgrad.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/pca.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/closest.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/bfs.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/constraint.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/quad_prog_solve.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/smart_ini_x.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/constrained_majorization.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/opt_arrangement.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/overlap.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/call_tri.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/compute_hierarchy.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/delaunay.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/multispline.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/sgd.c \
		$(GRAPHVIZ_ROOT)/lib/neatogen/randomkit.c \
		$(GRAPHVIZ_ROOT)/lib/twopigen/*.c \
		$(GRAPHVIZ_ROOT)/plugin/dot_layout/*.c \
		$(GRAPHVIZ_ROOT)/plugin/neato_layout/*.c \
		$(GRAPHVIZ_ROOT)/plugin/core/*.c \
		$(EXPAT_ROOT)/lib/*.c \
		patch.c \
		bind.c \
		-o $(TARGET)
